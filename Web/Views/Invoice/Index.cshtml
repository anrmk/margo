@{
    ViewData["Title"] = "Invoices";

    var tableId = Guid.NewGuid();

    var listUrl = Url.RouteUrl("GetInvoices");
    var deleteUrl = Url.RouteUrl("DeleteInvoices");
    var editUrl = Url.RouteUrl("EditInvoice");
}

@section RightSidebar {
    <form id="table-filter" class="ui form">
        <h1>Filters</h1>
        <input id="@(tableId)_is_person" type="hidden" name="IsPerson" data-value-type="boolean" />
        <input id="@(tableId)_customer_id" type="hidden" name="Customer" data-value-type="string" />

        <div class="field">
            <label>Unpaid</label>
        </div>
        <div class="field">
            <div class="ui slider checkbox">
                <input id="@(tableId)_unpaid-checkbox" name="Unpaid" type="checkbox" data-value-type="boolean" />
                <label />
            </div>
        </div>
        <div class="field">
            <label>Vendor</label>
            <select id="@(tableId)_vendors-select" name="Vendor" asp-items="@ViewBag.Vendors" class="ui fluid dropdown">
                <option value="" selected disabled hidden>Select vendor</option>
            </select>
        </div>
        <div class="field">
            <label>Customer</label>
            <select id="@(tableId)_companies-persons-select" asp-items="@ViewBag.CompaniesAndPersons" class="ui fluid dropdown">
                <option value="" selected disabled hidden>Select customer</option>
            </select>
        </div>
    </form>
}

<div>
    <div id="toolbar" class="ui secondary menu">
        <a asp-route="AddInvoice" class="ui button" data-request="ajax" rel="dialog" data-title="Create invoice"><i class="fa fa-plus mr-1"></i> Create</a>
        <div class="right menu">
            <button class="red ui button" data-action="delete" disabled><i class="trash icon"></i> Delete</button>
        </div>
    </div>

    <table id="@(tableId)" class="ui selectable celled unstackable orange table" data-toolbar="#toolbar"></table>
</div>

@section Scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            window.DocumentController = new DocumentController({
                'table': '#@tableId',
                'controller': {
                    'list': '@listUrl',
                    'delete': '@deleteUrl'
                },
                'columns': [
                    { 'title': '', 'data': 'id', 'className': 'collapsing', 'render': (data, type, row) => $.fn.renderDatatableAction(data, type, row) },
                    { 'title': 'No ', 'className': 'collapsing', 'data': 'no' },
                    { 'title': 'Customer name', 'data': 'customerName' },
                    { 'title': 'Date', 'className': 'collapsing', 'data': 'date', 'render': (data, type, row) => $.fn.formatDate(data, type, row) },
                    { 'title': 'Due date', 'className': 'collapsing', 'data': 'dueDate', 'render': (data, type, row) => $.fn.formatDate(data, type, row) },
                    { 'title': 'Amount', 'className': 'collapsing', 'data': 'amount' },
                    { 'title': 'Balance', 'className': 'collapsing', 'data': 'balanceAmount' },
                    { 'title': 'Status', 'className': 'collapsing', 'data': 'status' },
                    { 'title': 'Payment date', 'className': 'collapsing', 'data': 'paymentDate', 'render': (data, type, row) => $.fn.formatDate(data, type, row) },
                    { 'title': 'Modified', 'className': 'collapsing', 'data': 'updatedDate', 'render': (data, type, row) => $.fn.formatDate(data, type, row) }
                ],
                'onDblRowClick': (e, data) => {
                    $.get('@editUrl', { 'id': data.id }).done(result => {
                        $(result).dialog({ 'title': 'Edit invoice' });
                    });
                }
            });

            $('#@(tableId)_companies-persons-select').on('change', function () {
                let valueData = $(this).find(':selected').val().split('_');

                $('#@(tableId)_customer_id').val(valueData[1]);

                switch (valueData[0]) {
                    case "person":
                        $('#@(tableId)_is_person').val(true);
                        break;
                    case "company":
                        $('#@(tableId)_is_person').val(false);
                        break;
                }
                window.DocumentController.reload(false);
            });
            $('#@(tableId)_vendors-select').on('change', function () {
                window.DocumentController.reload(false);
            });
            $('#@(tableId)_unpaid-checkbox').on('change', function () {
                window.DocumentController.reload(false);
            });
        });

        ajaxSubmitComplete = function (e, jqXHR, status) {
            if (status === 'success') {
                window.DocumentController.reload(false);
                window.dialog.modal('hide');
            }
        };

        ajaxClick = function (e, jqXHR, status) {
            if (status === 'success') {
                var target = $(e.target).attr('data-target');
                $(target).remove();
            }
        };
    </script>
}
